# 成本和报价 — 计算公式说明

当前项目已实现与规划中的计算方法、公式汇总。

---

## 一、当前已实现

### 1. 1039 模式 — FOB（美元）

```
FOB (USD) = (EXW + 代理费 + 国内段运费 + 利润) / (汇率 × 0.998)
```

| 项 | 含义 | 当前取值 |
|----|------|----------|
| **EXW** | 出厂价（人民币） | 用户输入 |
| **代理费** | 1039 代理等费用 | 固定 80 元 |
| **国内段运费** | 义乌→港口 或 工厂→港口 | 义乌发出默认 120 元；工厂直发默认 0，可用户填 |
| **利润** | 按 EXW 的百分比 | 利润 = EXW × 利润率% / 100 |
| **汇率** | 结汇用人民币/美元 | 用户输入，默认 7.25 |
| **0.998** | 结汇损耗/手续费系数 | 固定 |

**分步：**

1. 利润(CNY) = EXW × 利润率% / 100  
2. 国内段(CNY) = 发货地默认或用户填（工厂直发可填 0 或实际运费）  
3. 总成本(CNY) = EXW + 80 + 国内段 + 利润  
4. FOB(USD) = 总成本(CNY) / (汇率 × 0.998)，保留两位小数  

---

### 2. 一般贸易模式 — FOB（美元）

```
FOB (USD) = EXW / 汇率
```

出厂价直接按汇率折算成美元，无代理、国内段、利润加成。

---

## 二、规划中（箱规、重量、国内段按量）

### 1. 体积（CBM）

```
体积 (CBM) = 长(cm) × 宽(cm) × 高(cm) / 1,000,000
```

单位：立方米。长宽高单位须为 **cm**。

**箱规加量（可选）**：报价时可在长宽高各加 0/1/2/3 cm 再算体积，用于保守报价。

```
体积(CBM) = (长 + 加量)(cm) × (宽 + 加量)(cm) × (高 + 加量)(cm) / 1,000,000
```

---

### 2. 体积重（公斤）

```
体积重 (kg) = 长(cm) × 宽(cm) × 高(cm) / 系数
```

| 系数 | 常见用途 |
|------|----------|
| 6000 | 空运常用 |
| 5000 | 海运/部分快递 |

系数可配置或用户选「空运/海运」。

---

### 3. 计费重（公斤）

```
计费重 (kg) = max(实重, 体积重)
```

- 实重 > 体积重 → 按重计费（重货）  
- 体积重 > 实重 → 按体积计费（抛货）  

---

### 4. 国内段运费（按量）

用户选计费方式后，系统按下列之一计算国内段（人民币）：

**按重：**

```
国内段(CNY) = 单价(元/吨) × 计费重(kg) / 1000
```

**按体积：**

```
国内段(CNY) = 单价(元/CBM) × 体积(CBM)
```

**按柜/按车：**

```
国内段(CNY) = 单价(元/柜或元/车)
```

（若支持多柜，再 × 柜数。）

---

### 5. FOB（扩展 — 国内段按上面算出）

```
利润(CNY) = EXW × 利润率% / 100
总成本(CNY) = EXW + 代理费 + 国内段(按量或固定) + 利润
FOB(USD) = 总成本(CNY) / (汇率 × 0.998)
```

国内段可为：固定一车价（如 120）、或按重/按体积/按柜算出的金额。

---

## 三、散货海运费（统一公式）

海运散货：**计费数(吨) = max(体积 CBM, 毛重 kg/1000)**，海运常按 1 CBM = 1 吨。

```
计费数(吨) = max(体积(CBM), 毛重(kg)/1000)
海运费(元) = 单价(元/吨或元/CBM) × 计费数(吨)
```

- **实重(吨)** = 毛重(kg) / 1000（计费用毛重，不用净重）
- **体积重(吨)** = 体积(CBM) × 1（海运 1 CBM = 1 吨）
- 到港运费(USD) = 海运费(元) / 汇率，用于 CFR/CIF

---

## 四、到岸价（已实现）

### 1. CFR（成本 + 运费 + 附加费）

```
CFR (USD) = FOB (USD) + 到港运费 (USD) + 附加费 (USD)
```

到港运费可：用户直接填 USD；或按散货单价自算（海运单价 × 计费数 → 元 → ÷ 汇率 = USD）；或整柜（元/柜 × 柜数 → ÷ 汇率 = USD）。  
常见附加费（THC、DOC、BAF、CAF 等）在询盘/报价阶段可算上，用户填「附加费 USD」合计，参与 CFR/CIF。

### 2. CIF（成本 + 运费 + 保险）

```
CIF (USD) = FOB (USD) + 到港运费 (USD) + 保险费 (USD)
```

保险费可用户输入，或按比例估算。

---

## 五、公式汇总表

| 结果 | 公式 |
|------|------|
| 体积 CBM | 长×宽×高 / 1,000,000 |
| 体积重 kg | 长×宽×高 / 系数(6000或5000) |
| 计费重 kg | max(实重, 体积重) |
| 国内段(按重) | 元/吨 × 计费重/1000 |
| 国内段(按方) | 元/CBM × 体积 |
| 利润 CNY | EXW × 利润率% / 100 |
| 总成本 CNY | EXW + 代理费 + 国内段 + 利润 |
| **FOB USD** | 总成本 CNY / (汇率 × 0.998) |
| **CFR USD** | FOB + 到港运费 + 附加费 USD |
| **CIF USD** | CFR + 保险费 |
| **散货计费数(吨)** | max(体积 CBM, 毛重 kg/1000) |
| **散货海运费(元)** | 单价 × 计费数(吨) |

---

## 六、代码位置

- **FOB、国内段、利润、成本明细**：`lib/calc.ts`（`calcFobUsd`、`getCostBreakdown`、`getDomesticCny`）
- **体积、箱规加量、体积重、计费重、国内段按量**：`lib/calc.ts`（`calcVolumeCbm`、`calcVolumeCbmWithAllowance`、`calcVolumetricWeight`、`getChargeableWeight`、`calcDomesticCnyByWeight`、`calcDomesticCnyByVolume`）
- **散货海运费**：`lib/calc.ts`（`getSeaChargeableTon`、`calcSeaFreightCny`）
- **CFR/CIF**：`lib/calc.ts`（`calcCfrUsd`、`calcCifUsd`）
- **一般贸易 FOB**：`lib/quote-actions.ts`（`tradeMode === 'general'` 时 EXW/汇率）
- **新建报价页**：`app/quote/new/page.tsx`（箱规与重量、国内段计费方式、成本明细、到岸价可选区块）
