# 报价逻辑与字段说明（组成部分 · 单位 · 提供方 · 流程提示）

本文档整理当前报价逻辑的**组成部分**、**字段及数值单位**、**数据提供方**，以及**业务流程中何时获取/询问价格**的提示。**先不实施**，仅作规划与核对用。

---

## 一、业务流程简要

| 阶段 | 说明 | 本工具中的动作 |
|------|------|----------------|
| **客户询盘** | 客户问价、问条款、问起订量等 | 销售用「智能粘贴」解析产品名/单价/客户名，准备报价 |
| **报价前准备** | 需凑齐：出厂价、国内段成本、汇率、利润；若报 CFR/CIF 还需海运费与附加费 | 向工厂/供应商要 EXW、箱规重量；向货代要运价表或单票报价；关注汇率 |
| **生成报价** | 填表算出 FOB（及可选 CFR/CIF），生成链接发给客户 | 新建报价页：填字段 → 生成链接 |
| **客户打开链接** | 客户查看报价、可能申请解锁 | 系统记录访问、时长、可设受控访问 |
| **成单/复盘** | 实际结汇、实际运费可能与报价时不同 | 报价页可锁定汇率；CFR/CIF 为询盘阶段参考，以货代最终账单为准 |

**流程提示（何时询问价格/数据）**见下文各组成部分的「流程提示」小节。

---

## 二、报价组成部分总览

```
┌─────────────────────────────────────────────────────────────────┐
│  FOB 报价（装运港船上交货，必算）                                  │
│  = 出厂成本(EXW) + 代理费 + 国内段运费 + 利润 → 换算 USD           │
└─────────────────────────────────────────────────────────────────┘
         │
         │  若需要到岸价
         ▼
┌─────────────────────────────────────────────────────────────────┐
│  CFR/CIF（可选）                                                  │
│  CFR = FOB + 到港运费(USD) + 附加费(USD)                          │
│  CIF = CFR + 保险费(USD)                                         │
└─────────────────────────────────────────────────────────────────┘
```

- **FOB**：不含海运及附加费，附加费**不**参与 FOB。
- **CFR/CIF**：到港运费与附加费在「到岸价」区块中填写，仅影响 CFR/CIF 展示与参考，**当前不入库**（仅前端计算与展示）。

---

## 三、组成部分一：FOB 成本（1039 模式）

**公式：**  
`FOB (USD) = (EXW + 代理费 + 国内段运费 + 利润) / (汇率 × 结汇系数 0.998)`

### 3.1 字段与单位

| 组成部分 | 字段名（页面/逻辑） | 数值单位 | 提供方 | 流程提示 |
|----------|---------------------|----------|--------|----------|
| 出厂价 | EXW / 出厂价 / exw_price | 元 (CNY) | 工厂/供应商 | **询盘时或报价前**向工厂要含税出厂价（EXW 义乌或工厂门口价） |
| 代理费 | 代理费 / agent_fee | 元 (CNY) | 系统默认 | 1039 代理等固定成本，当前默认 **80 元**（可环境变量覆盖） |
| 国内段运费 | 国内段 / domestic_cny | 元 (CNY) | 物流/货代或系统默认 | **报价前**确定发货地：义乌发出默认 **120 元**；工厂直发默认 0，或向物流要「工厂→港口」单价后在本工具按重/按方/按柜算 |
| 利润 | 利润率 / profit_margin | % | 销售自定 | 报价时自定，常用 10%～20%，利润(元) = EXW × 利润率% / 100 |
| 汇率 | 汇率 / exchange_rate | 人民币/美元 | 银行/结汇渠道或自定 | **报价时**填写，建议用近期结汇价或锁汇价；可勾选「锁定汇率」在报价页展示锚定汇率 |
| 结汇系数 | settlement_factor | 无量纲 | 系统默认 | 结汇损耗/手续费系数，当前 **0.998**（可环境变量覆盖） |

### 3.2 一般贸易模式（非 1039）

| 组成部分 | 字段名 | 数值单位 | 提供方 | 流程提示 |
|----------|--------|----------|--------|----------|
| FOB | EXW / 汇率 | EXW 元，汇率 CNY/USD | 工厂 + 自定汇率 | FOB(USD) = EXW(元) / 汇率，无代理费、国内段、利润加成 |

---

## 四、组成部分二：箱规与重量（用于国内段按量计费 + 散货海运费）

仅在 **1039 模式** 且需要「按重/按方/按柜」计国内段、或需要算**散货(LCL)海运费**时填写。

### 4.1 字段与单位

| 组成部分 | 字段名 | 数值单位 | 提供方 | 流程提示 |
|----------|--------|----------|--------|----------|
| 箱规 | 长 / 宽 / 高 | cm | 工厂/供应商 | **报价前**向工厂要单箱外尺寸（长×宽×高，厘米） |
| 箱规加量 | 加量 0/1/2/3 cm | cm | 销售自定 | 保守报价时可在三边各加 0～3 cm 再算体积 |
| 毛重 | 毛重 / gross_weight | kg | 工厂/供应商 | **报价前**向工厂要单箱毛重（公斤），用于计费重、散货计费吨 |
| 体积 | 体积 CBM | m³ | 系统按箱规计算 | 体积 = (长+加量)×(宽+加量)×(高+加量) / 1,000,000 |
| 体积重 | 体积重 | kg | 系统按箱规+系数计算 | 体积重 = 长×宽×高 / 系数（空运常用 6000，海运可用 5000） |
| 计费重 | 计费重 | kg | 系统 | max(毛重, 体积重)，用于国内段「按重」计费 |

### 4.2 国内段计费方式（1039）

| 计费方式 | 字段名 | 数值单位 | 提供方 | 流程提示 |
|----------|--------|----------|--------|----------|
| 固定 | 发货地：义乌 / 工厂直发；工厂直发时可填「国内段 元」 | 元 (CNY) | 自定 / 物流 | 义乌发出默认 120 元；工厂直发填 0 或向物流要一口价 |
| 按重 | 元/吨 domestic_yuan_per_ton | 元/吨 | 物流/货代 | **报价前**向国内物流要「元/吨」单价，系统按计费重(kg)/1000 算 |
| 按方 | 元/CBM domestic_yuan_per_cbm | 元/CBM | 物流/货代 | **报价前**要「元/方」单价，系统按体积(CBM) 算 |
| 按柜 | 元/柜 domestic_yuan_per_container | 元/柜 | 物流/货代 | **报价前**要「元/柜」或「元/车」单价 |

---

## 五、组成部分三：到岸价 CFR / CIF（可选）

**公式：**  
- `CFR (USD) = FOB (USD) + 到港运费(USD) + 附加费(USD)`  
- `CIF (USD) = CFR (USD) + 保险费(USD)`

到港运费可来自：**散货(LCL) 自算**、**整柜(FCL) 自算**、或**直接填货代给的 USD**。

### 5.1 海运方式与字段

| 海运方式 | 字段名 | 数值单位 | 提供方 | 流程提示 |
|----------|--------|----------|--------|----------|
| **散货 LCL** | 海运单价 元/吨（或元/CBM）sea_yuan_per_ton | 元/吨 或 元/CBM | 货代 | **报价前**向货代要目的港散货单价；系统：计费数(吨)=max(体积CBM, 毛重kg/1000)，海运费(元)=单价×计费数，再÷汇率得 USD |
| **整柜 FCL** | 柜型 container_type；柜数 container_count；元/柜 yuan_per_container | 20GP/40GP/40HQ；柜；元/柜 | 货代 | **报价前**向货代要「某柜型 元/柜」及柜数；系统：海运费(元)=元/柜×柜数，再÷汇率得 USD |
| **直接填运费** | 到港运费 USD freight_usd | USD | 货代 | **报价前**向货代要单票 all-in 或「海运费+附加费」合计 USD，直接填入 |

### 5.2 附加费与保险

| 组成部分 | 字段名 | 数值单位 | 提供方 | 流程提示 |
|----------|--------|----------|--------|----------|
| 附加费 | 附加费 USD surcharge_usd | USD | 货代 | **报价前**货代报价中的 THC、DOC、BAF、CAF 等，可填合计 USD；仅参与 CFR/CIF，**不参与 FOB** |
| 保险费 | 保险费 USD insurance_usd | USD | 货代/保险公司或自估 | CIF 时填写；可向货代询或按货值比例估 |

### 5.3 流程提示小结（到岸价）

- **何时问货代**：客户询盘若涉及目的港、到岸价时，在**生成报价前**向货代询：散货单价（元/吨或元/CBM）、或整柜元/柜、或单票 USD，以及附加费（可合计 USD）。
- **价格动态**：海运费和附加费随航线、季节变动，报价时填的是**当时**货代报价，实际以订舱时货代最终账单为准；本工具不做实时拉价，全部为**用户手动输入**。

---

## 六、其他与报价相关的字段（页面/权限）

| 用途 | 字段名 | 数值单位 | 提供方 | 说明 |
|------|--------|----------|--------|------|
| 产品名 | product_name | 文本 | 询盘/工厂 | 必填，可智能粘贴解析 |
| 客户名 | customer_name | 文本 | 询盘 | 可选，备注用 |
| 贸易方式 | trade_mode | 1039 / general | 自定 | 决定是否含代理费、国内段、利润 |
| 锁定汇率 | exchange_rate_locked | 同汇率 | 自定 | 勾选则在报价页展示锚定汇率 |
| 受控访问 | access_controlled | 布尔 | 自定 | 勾选则客户需申请后才可见价格 |

---

## 七、数据提供方汇总

| 提供方 | 提供的字段/数据 | 业务流程中的时机 |
|--------|-----------------|-------------------|
| **工厂/供应商** | EXW(元)、箱规(cm)、毛重(kg) | 询盘时或报价前 |
| **货代** | 国内段：元/吨、元/CBM、元/柜；国际段：散货单价、整柜元/柜、或到港运费 USD、附加费 USD、保险 | 报价前（客户问到岸价时） |
| **银行/结汇** | 汇率 | 报价时、锁汇时 |
| **销售/自定** | 利润率、客户名、是否锁定汇率、是否受控访问、箱规加量 | 报价时 |

---

## 八、当前持久化范围（与未持久化项）

- **入库（quotes 表）**：产品名、EXW、利润率、客户名、贸易方式、汇率、是否锁定汇率、是否受控访问、发货地及国内段（用于计算 FOB）、**FOB(USD)**。  
- **未入库**：箱规/毛重、国内段按量单价、到岸价区块（海运方式、柜型柜数、元/柜、海运单价、到港运费 USD、附加费 USD、保险费 USD）、**CFR/CIF 结果**。  
  以上未入库项仅在前端用于计算与展示，不写入数据库；若后续要「报价页展示历史 CFR/CIF」，需在库表与 createQuote 中增加对应字段与写入逻辑。

---

## 九、单位与公式速查

| 结果/中间量 | 单位 | 公式或来源 |
|-------------|------|------------|
| 体积 CBM | m³ | (长+加量)(cm)×(宽+加量)×(高+加量) / 1,000,000 |
| 体积重 | kg | 长×宽×高(cm) / 系数(如 6000) |
| 计费重 | kg | max(毛重, 体积重) |
| 散货计费数 | 吨 | max(体积 CBM, 毛重 kg/1000) |
| 国内段(按重) | 元 | 元/吨 × 计费重(kg)/1000 |
| 国内段(按方) | 元 | 元/CBM × 体积(CBM) |
| 利润 | 元 | EXW × 利润率% / 100 |
| 总成本 | 元 | EXW + 代理费 + 国内段 + 利润 |
| FOB | USD | 总成本(元) / (汇率 × 0.998) |
| 散货海运费 | 元 | 海运单价(元/吨) × 计费数(吨) |
| 整柜海运费 | 元 | 元/柜 × 柜数 |
| CFR | USD | FOB + 到港运费(USD) + 附加费(USD) |
| CIF | USD | CFR + 保险费(USD) |

以上为当前报价逻辑的完整整理，**先不实施**，便于与业务核对后再改表或改流程。
